# LAN을 넘어서는 네트워크 계층

LAN을 넘어서 다른 네트워크와 통신하기 위해서는 네트워크 계층의 역할이 필수적이다.

네트워크 계층에서는 IP주소를 이용해 송수신지 대상을 지정하고, 다른 네트워크에 이르는 경로를 결정하는 라우팅을 통해 다른 네트워크와 통신한다.

<br>

## 데이터 링크 계층의 한계

물리 계층과 데이터 링크 계층만으로는 LAN을 넘어서 통신하기 어렵다.

1. 다른 네트워크까지의 도달 경로를 파악하기 어렵다.

물리 계층

- 단순히 신호를 전기적/광학적으로 전달한다.
- 데이터의 내용이나 목적지를 인식하지 않는다.

데이터 링크 계층

- 같은 네트워크 내에서 통신이 가능하다.
- 통신 대상은 MAC 주소로 식별된다.

→ 2계층 까지는 같은 네트워크 안에서 누가 누구인지만 알 수 있고, 다른 네트워크로는 어디로 보내야 하는지 알 수 없다.

⇒ 물리 계층과 데이터 링크 계층의 장비로는 라우팅을 수행할 수 없다.

<aside>

> 라우팅 : 
> 패킷이 이동할 최적의 경로를 결정하는 것 <br>
> 네트워크 계층의 장비로 수행할 수 있다.

</aside>
<br>

2. MAC 주소만으로는 모든 네트워크에 속한 호스트의 위치를 특정하기 어렵다.

MAC 주소

- 택배의 수신인
- 물리 주소
- 일반적으로 NIC마다 할당되는 고정된 주소

IP 주소 : 택배의 수신지

- 택배의 수신지
- 논리 주소
- 호스트에 직접 할당이 가능하다
    - DHCP라는 특정 프로토콜을 통해 자동으로 할당받거나
    - 사용자가 직접 할당할 수 있다.
- 한 호스트가 복수의 IP주소를 가질 수도 있다.
<br>

| 구분 | MAC 주소 | IP 주소 |
| --- | --- | --- |
| 주소 종류 | 물리 주소 | 논리 주소 |
| 할당 방식 | NIC 제조 시 고정 | 사용자 또는 DHCP에 의해 할당 |
| 위치 정보 포함 여부 | X | O |
| 사용 계층 | 데이터 링크 계층 (2계층) | 네트워크 계층 (3계층) |
| 통신 범위 | 동일 네트워크 내부 | 네트워크 간 통신 가능 |

<br>

## 인터넷 프로토콜

### IP 주소 형태 (IPv4)

IP 주소는 4바이트로 주소를 표현할 수 있고, 

숫자당 8비트로 표현되기에 0~255 범위 안에 있는 네 개의 10진수로 표기된다.

각 10진수는 점으로 구분되며, 점으로 구분된 8비트를 **옥텟**이라고 한다.

Ex) 192.168.1.1  / 옥텟 : 192, 168, 1, 1

### IP의 기능

- IP 주소 지정
    - IP 주소를 바탕으로 송수신 대상을 지정하는 것을 의미
- IP 단편화
    - 전송하고자 하는 패킷의 크기가 MTU(최대 전송 단위)보다 클 경우, 이를 MTU 크기 이하의 복수의 패킷으로 나누는 것을 의미

MTU

- 한 번에 전송 가능한 IP 패킷의 최대 크기를 의미한다.
- IP 패킷의 헤더도 MTU 크기에 포함된다.
- 일반적으로 1500바이트의 크기이며,  MTU 크기 이하로 나누어진 패킷은 수신지에 도착하면 다시 재조합된다.

## IPv4

IPv4 패킷은 프레임의 페이로드로 데이터 필드에 명시된다.


식별자, 플래그, 단편화 오프셋 → IP 단편화 기능

송신지 IP 주소, 수신지 IP 주소 → IP 주소 지정 기능에 관여

### 식별자

- 패킷에 할당된 번호
- 쪼개진 패킷들이 어떤 메시지에서부터 쪼개졌는지를 인식하기 위해 식별자를 사용한다.

### 플래그

- 총 세개의 비트로 구성된 필드
- 첫 번째 비트는 항상 0으로 예약된 비트로 현재 사용되지 않는다.
- DF : 나머지 두 개의 비트 중 하나의 비트
    - Don’t Fragment의 약어로, IP 단편화를 수행하지 말라는 표시
    - 1로 설정되어 있다면 IP단편화를 수행하지 않고, 0으로 설정되어 있다면 IP단편화가 가능
    - DF 비트가 1로 설정되었다고 해도 패킷의 크기가 너무 크다면 이는 폐기된다. (쪼개는 게 아니라 버려버린다.)
- MF : 나머지 하나의 비트
    - More Fragment의 약어로, 단편화된 패킷이 더 있는지를 나타낸다.
    - 0이라면 마지막 패킷임을 의미하고, 1이라면 쪼개진 패킷이 아직 더 있다는 것을 의미

### 단편화 오프셋

- 패킷이 단편화되기 전에 패킷의 초기 데이터에서 몇 번째로 떨어진 패킷인지를 나타낸다.
- 수신지가 패킷들을 순서대로 재조합 하기 위한 정보
    - (패킷들이 수신지에 순서대로 도착하지 않을 수 있기 때문)

### TTL (Time To Live)

- 패킷의 수명을 의미
- 패킷이 하나의 라우터를 거칠 때마다 TTL이 1씩 감소하며, 값이 0으로 떨어진 패킷은 폐기된다.
    - 패킷이 폐기되면 송신한 호스트에게 시간 초과 메시지가 전송된다. (ICMP 프로토콜)
- 무의미한 패킷이 네트워크 상에 지속적으로 남아있는 것을 방지한다.

<aside>

>홉 : 패킷이 호스트 또는 라우터에 한 번 전달되는 것
>→ TTL 필드의 값은 홉마다 1씩 감소한다.

</aside>

### 프로토콜

- 상위 계층의 프로토콜이 무엇인지를 나타내는 필드
- Ex) TCP : 6, UDP : 17

## IPv6

IPv4의 주소 총량이 부족하다. → IPv6의 등장

16바이트로 주소를 표현할 수 있고, 콜론으로 구분된 8개의 그룹의 16진수로 표기된다.

<br>

### 다음 헤더

- 상위 계층의 프로토콜을 가리키거나 확장 헤더를 가리킨다.
- 확장 헤더
    - 위의 그림에 표현된 헤더는 기본 헤더, 추가적인 헤더 정보가 필요할 경우 기본 헤더와 더불어 확장 헤더라는 추가 헤더를 가질 수 있다.
    - 기본 헤더와 페이로드 데이터 사이에 위치한다.


### IPv6의 단편화

IPv6는 IPv4와 달리 기본 헤더에 단편화 관련 필드가 없고, 단편화 확장 헤더를 통해 단편화가 이루어진다.


예약됨과 예약 필드는 0으로 설정되어 사용되지 않는다.

단편화 오프셋, 식별자 필드 → IPv4의 단편화 오프셋, 식별자 필드

M 플래그 → MF 플래그

<br>

### 홉 제한

- IPv4 패킷의 TTL 필드와 비슷하게 패킷의 수명을 나타내는 필드

## ARP

일반적으로 MAC 주소와 IP 주소는 함께 사용하지만, 기본적으로는 IP 주소를 사용한다.

이 과정에서 IP주소는 알지만, MAC 주소는 알지 못하는 상황이 있을 수 있다.

이 때 ARP라는 프로토콜을 사용한다.

- IP 주소를 통해 MAC 주소를 알아내는 프로토콜
- 동일 네트워크 내에 있는 송수신 대상의 IP 주소를 통해 MAC 주소를 알아낼 수 있다.

### ARP의 동작 과정

1. ARP 요청
    1. 네트워크 내의 모든 호스트에게 브로드캐스트 메시지를 보낸다.
        1. 메시지는 ARP 요청이라는 ARP 패킷이다.
2. ARP 응답
    1. 네트워크 내의 모든 호스트가 ARP 요청 메시지를 수신하지만, B를 제외한 나머지 호스트는 자신의 IP 주소가 아니므로 이를 무시한다.
    2. B는 자신의 MAC 주소를 담은 메시지를 A에게 전송한다.
        1. 유니캐스트 메시지는 ARP 응답이라는 ARP 패킷이다.
3. ARP 테이블 갱신
    1. ARP를 활용할 수 있는 모든 호스트는 ARP 테이블이라는 정보를 유지한다.
    2. MAC 주소를 알게되면 ARP 테이블에 추가한다.
    3. ARP 테이블은 일정 시간이 지나면 삭제되고, 임의로 삭제할 수 있다.
        1. 테이블에 정보가 있다면 ARP 요청을 보낼 필요가 없어진다.

### ARP 패킷

ARP 패킷은 프레임의 페이로드에 포함되어 전송된다.

- 오퍼레이션 코드
    - ARP 패킷의 유형을 나타낸다.
    - ARP 요청의 경우 1, 응답의 경우 2로 설정된다.
- 하드 웨어 주소 : MAC 주소가 명시
- 프로토콜 주소 : IP 주소가 명시

### 다른 네트워크의 호스트 A, B 통신

1. 호스트 A가 ARP 요청, 라우터 A가 ARP 응답
2. 호스트 A가 라우터 A로 패킷 전송
3. 라우터 A가 ARP 요청, 라우터 B가 ARP 응답
4. 라우터 A가 라우터 B로 패킷 전송
5. 라우터 B가 ARP 요청, 호스트 B가 ARP 응답
6. 라우터 B가 호스트 B로 패킷 전송

⇒ 데이터를 전달하기 위해서는 MAC 주소가 필요하고,  
데이터를 어느 장치로 보낼지 찾기 위해서는 IP 주소가 필요하다.

<br>

### IP 단편화는 많이 수행되는 것이 좋을까? 적게 수행되는 것이 좋을까?
→ 되도록 하지 않는 것이 좋다.  

데이터가 여러 패킷으로 쪼개지면 전송해야할 패킷의 헤더들도 많아지고, 

불필요한 트래픽 증가와 대역폭 낭비로 이어질 수 있다.

또 쪼개진 IP 패킷들을 하나로 합치는 과정에서 발생하는 부하도 성능 저하를 야기할 수 있다.

<br>

### IP 단편화는 어떻게 피할 수 있을까?

IP 패킷을 주고 받는 모든 호스트의 처리 가능한  MTU 크기를 고려해야 한다. → 경로 MTU

경로 MTU를 구하고 해당 크기만큼만 송수신하여 IP 단편화를 회피하는 기술을 경로 MTU 발견이라고 한다.

(DF 플래그를 통해 데이터의 크기를 구할 수 있다.)
