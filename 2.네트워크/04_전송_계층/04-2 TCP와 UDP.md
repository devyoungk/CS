# 2. TCP와 UDP

전송 계층의 핵심인 TCP와 UDP 알아보기

---

## TCP 통신 단계와 세그먼트 구조

TCP 통신은 크게 1. 연결 수립 / 2. 데이터 송수신 / 3. 연결 종료 세 단계로 나눌 수 있다

**MSS** : TCP로 전송할 수 있는 최대 페이로드 크기

**TCP 세그먼트 헤더 구조**

- **송신지 포트**/**수신지 포트** : 송신지 or 수신지 애플리케이션을 식별하는 포트 번호가 명시되는 필드
- **순서 번호** : 순서 번호가 명시되는 필드
- **확인 응답 번호** : 상대 호스트가 보낸 세그먼트에 대한 응답
- **제어 비트** : 현재 세그먼트에 대한 부가 정보 나타냄
- **윈도우** : 수신 윈도우의 크기 명시

#### 제어 비트

- **ACK** : 세그먼트의 승인을 나타내기 위한 비트
- **SYN** : 연결을 수립하기 위한 비트
- **FIN** : 연결을 종료하기 위한 비트

#### 순서 번호와 확인 응답 번호

TCP의 신뢰성을 보장하기 위해 사용

- **순서 번호** : TCP 세그먼트의 순서를 나타내기 위한 정
    - 처음 통신을 위해 연결 → 순서 번호 무작위 값 → **초기 순서 번호**
    - 순서번호 = 초기 순서 번호 + 송신한 바이트 수
- **확인 응답 번호** : 수신 호스트가 다음으로 받기를 희망하는 순서 번호
    - 일반적으로 수신한 순서 번호 + 1

---

## TCP 연결 수립과 종료

#### 연결 수립: 쓰리 웨이 핸드셰이크

세 개의 단계로 이루어진 TCP의 연결 수립 과정 (SYN → SYN+ACK → ACK)

- **액티브 오픈** : 처음 연결을 시작하는 호스트의 연결 수립 과정
- **패시브 오픈** : 연결 요청을 받고 나서 요청에 따라 연결을 수립

#### 연결 종료

연결을 수립한 뒤 데이터 송수신이 끝났다면 → 연결 종료해야 함

⇒ 송수신 호스트가 각자 한 번씩 FIN, ACK 주고받음 

- **액티브 클로즈** : 먼저 연결을 종료하려는 호스트에 의해 수행
- **패시브 클로즈** : 연결 종료 요청을 받아들이는 호스트에 의해 수행

---

## TCP 상태

**상태** : 현재 어떤 통신 과정에 있는지를 나타내는 정보

(TCP → **스테이트풀** 프로토콜이라고도 부름)

#### 1. 연결이 수립되지 않은 상태 
  - **CLOSED** : 아무런 연결이 없는 상태
  - **LISTEN** : 일종의 연결 대기 상태. SYN 세그먼트를 기다리는 상태
#### 2. 연결 수립 상태 
  - **SYN-SENT** : 액티브 오픈 호스트가 SYN 세그먼트 보낸 뒤 SYN+ACK 세그먼트 기다리는 상태
  - **SYN-RECEIVED** : 패시브 오픈 호스트가 SYN+ACK 세그먼트 보낸 뒤 ACK 세그먼트 기다리는 상태
  - **ESTABLISHED** : 연결이 확립되었음을 나타내는 상태
#### 3. 연결 종료 상태 
  - **FIN-WAIT-1** : 액티브 클로즈 호스트가 FIN 세그먼트 보낸 상태
  - **CLOSE-WAIT** : FIN 받은 패시브 클로즈 호스트가 ACK 세그먼트 보낸 후 대기하는 상태
  - **FIN-WAIT-2** : FIN-WAIT-1 상태에서 ACK 세그먼트 받은 상태
  - **LAST-ACK** : CLOSE-WAIT 상태에서 FIN 세그먼트 전송한 뒤 ACK 세그먼트 기다리는 상태
  - **TIME-WAIT** : 액티브 클로즈 호스트가 FIN 세그먼트 수신 후, ACK 세그먼트 전송한 상태

---

## UDP 데이터그램 구조

UDP → **스테이트리스** 프로토콜

**UDP 데이터그램 구조**

- **송신지 포트**/**수신지 포트** : 송수진지의 포트 번호
- **길이** : 헤더를 포함한 UDP 데이터그램의 바이트
- **체크섬** : 데이터그램 전송 과정에서 오류 발생했는지 검사하기 위한 필드
