# 15-2 파일 시스템

## 파일 시스템

파일 시스템은 파일과 디렉터리를 보조 기억 장치에 일목 요연하게 저장하고,

접근할 수 있게 하는 OS 내부 프로그램이다.

파일 시스템에는 다양한 종류가 있고, 하나의 컴퓨터에서 여러 파일 시스템을 사용할 수 있다.

### 파티셔닝과 포매팅

보조 기억 장치를 사용하려면 파티션을 나누는 작업과 포맷 작업을 거쳐야 한다.

- 파티셔닝
    - 저장 장치의 논리적인 영역을 구획하는 작업을 의미
    - 서랍 안에서 칸막이로 영역을 나누는 작업
    - 파티셔닝 작업을 통해 나누어진 영역 하나하나를 **파티션**이라고 한다.
- 포매팅
    - 파일 시스템을 설정하여 어떤 방식으로 파일을 저장하고 관리할 것인지를 결정하고, 새로운 데이터를 쓸 준비를 하는 작업을 의미
    - 저수준 포매팅
        - 저장 장치를 생성할 당시 공장에서 수행되는 물리적인 포매팅
    - 논리적 포매팅
        - 파일 시스템을 생성하는 포매팅

---

### 파일 할당 방법

운영체제는 파일과 디렉터리를 블록 단위로 읽고 쓴다.

파일을 보조 기억장치에 할당하는 방법

- 연속 할당
- 불연속 할당 : 오늘날까지 사용되는 방식
    - 연결 할당
    - 색인 할당

---

### 연속 할당

이름 그대로 보조 기억 장치 내 연속적인 블록에 파일을 할당하는 방식

연속으로 할당된 파일에 접근하기 위해서는 파일의 첫 번째 블록 주소와 블록 단위의 길이만 알면 된다.

⇒ 연속 할당을 사용하는 파일 시스템에서는 디렉터리 엔트리에 **파일 이름**과 **첫 번째 블록 주소, 블록 단위의 길이**를 명시한다.

장점

- 구현이 단순하다.

단점

- 외부 단편화
    - 파일들을 연속 할당하고 중간의 파일들을 지웠을 때, 틈새 빈 공간이 생긴다.
    - 이 빈 공간이 여러 조각으로 나뉘어 있어, 전체적으로 충분한 공간이 있더라도 큰 파일을 한 덩어리로 넣지 못하는 상황이 생긴다.

---

### 연결 할당

연속 할당의 문제를 해결할 수 있는 방식이다.

각 **블록 일부에 다음 블록의 주소를 저장**하여 각 블록이 다음 블록을 가리키는 형태로 할당하는 방식이다.

→ 파일을 이루는 데이터를 연결 리스트로 관리한다.

연결 할당을 사용하는 파일 시스템에서는 디렉터리 엔트리에 연속 할당과 마찬가지로 **파일 이름**과 함께 **첫 번째 블록 주소**와 **블록 단위의 길이**를 명시한다.

→ 블록 단위의 길이 대신 마지막 블록 주소를 기록할 수도 있다.

단점

- 반드시 첫 번째 블록부터 하나씩 차례대로 읽어야 한다.
    - 파일의 중간 부분부터 접근하고 싶어도 반드시 파일의 첫 번재 블록부터 접근하여야 한다. → 임의 접근 속도가 매우 느리다.
- 하드웨어 고장이나 오류 발생 시 해당 블록 이후 블록은 접근할 수 없다.
    - 하나의 블록 안에 파일 데이터와 다음 블록 주소가 모두 포함되어 있으므로, 파일을 이루는 블록에 하나라도 문제가 발생하면 그 블록 이후의 블록에 접근할 수 없다.

⇒ 연결 할당을 변형한 대표적인 파일 시스템으로 FAT 파일 시스템이 있다.

---

### 색인 할당

파일의 모든 블록 주소를 **색인 블록**이라는 하나의 블록에 모아 관리하는 방식이다.

색인 블록에는 파일을 구성하는 블록들의 주소가 저장되어 있다.

색인 할당을 사용하는 파일 시스템 에서는 디렉터리 엔트리에 **파일 이름**과 더불어 **색인 블록 주소**를 명시한다.

장점

- 연결 할당과 달리 파일 내 임의의 위치에 접근하기 쉽다.
    - 색인 블록의 i번째 항목이 가리키는 블록에 접근하면 된다.

⇒색인 할당을 기반으로 만든 파일 시스템은 유닉스 파일 시스템이다.

---

### FAT 파일 시스템

연결 할당의 단점을 보완한 파일 시스템이다.

- 연결 할당 방식의 단점은 블록 안에 다음 블록의 주소를 저장하는 것이 원인이었다.

각 블록에 포함된 다음 블록의 주소들을 한데 모아 테이블 형태로 관리한다.

→ 파일 할당 테이블 (FAT)이라고 부른다.

FAT 파일 시스템은 버전에 따라 FAT12, FAT16, FAT32가 있다.

FAT 뒤에 오는 숫자는 블록을 표현하는 비트 수를 의미한다.

FAT 파일 시스템에서 FAT는 파티션의 앞 부분에 만들어진다.

예약 영역   |   FAT 영역   |   루트 디렉터리 영역   |   데이터 영역

- 예약 영역
    - 부트 섹터, FS 정보 등 파일 시스템을 설명하는 메타데이터
- FAT 영역
    - 블록(클러스터)들이 어떻게 연결돼 있는지 기록한 표 (연결 리스트 역할)
- 루트 디렉터리 영역
    - 루트 디렉터리 전용 공간 (FAT12, FAT16에서는 크기가 고정)
    - 이 안에 "루트 디렉터리 엔트리들"이 저장됨
    - FAT32에는 별도의 루트 디렉터리 영역이 없음
- 데이터 영역
    - 실제 파일 데이터와 일반 디렉터리 데이터가 저장되는 공간

<aside>
💡

**예약 영역의 의미**

- 디스크나 파티션의 앞부분 일부를 "특수 용도"로 비워두는 것
- 일반 파일이 저장되지 않고, 파일 시스템이 동작하기 위한 메타데이터가 기록됨
</aside>

장점

- FAT가 메모리에 캐시될 수도 있는데, 메모리에 적재된 채 실행되면 기존 연결 할당보다 다음 블록을 찾는 속도가 매우 빨라진다. → 임의 접근 성능 개선

---

### 유닉스 파일 시스템

색인 할당 기반의 파일 시스템이다.

유닉스 파일 시스템에서는 색인 블록을 **i-node** 라고 부른다.

디렉터리 엔트리에 **파일 이름**과 **i-node 번호**가 명시된다.

### i-node

- 파일 속성 정보와 열다섯 개의 블록 주소가 저장될 수 있다.
- 디렉터리 엔트리가 아닌 i-node에 파일 속성 정보가 포현된다.
- i-node의 크기는 유한하다.
    - 기본적으로 열다섯 개의 블록 주소를 저장할 수 있기 때문에 열다섯 개의 블록을 차지하는 파일까지 가리킬 수 있다. (최대는 아님)

파일마다 이러한 i-node가 있고, i-node마다 번호가 부여되어 있다.

i-node들은 다음과 같이 파티션 내 특정 영역에 모여 있다.

예약 영역  |  i-node 영역  |  데이터 영역

**블록을 열다섯개 이상 차지하는 파일은 어떻게 가리킬까?**

1. 블록 주소 중 열두 개에는 직접 블록 주소를 저장한다.
    1. 처음 열두 개에는 파일 데이터가 저장된 블록 주소가 직접적으로 명시된다. → 직접 블록
2. 열두 개의 블록 주소로 충분하지 않다면 열세 번째 주소에 단일 간접 블록 주소를 저장한다.
    1. 단일 간접 블록 : 파일 데이터가 저장된 블록이 아닌 파일 데이터를 저장한 블록 주소가 저장된 블록을 의미
3. 2번으로 충분하지 않다면 이중 간접 블록 주소를 저장한다. (열네 번째)
    1. 이중 간접 블록 주소 : 단일 간접 블록 주소가 저장된 블록
4. 3번으로 충분하지 않다면 삼중 간접 블록 주소를 저장한다. (열다섯 번째)
    1. 삼중 간접 블록 주소 : 이중 간접 블록 주소가 저장된 블록

⇒ 파일 크기가 크더라도 파일 데이터를 모두 가리킬 수 있다.

---

### 저널링 파일 시스템

파일 시스템을 변경하는 도중에 시스템 크래시가 발생하면 파일 시스템이 훼손될 수 있다.

저널링 파일 시스템이 있기 전에는 이런 상황이 발생하면 부팅 직후 파일 시스템을 검사하고 복구하는 프로그램을 실행시켰다.

→ 모든 블록에 대해 파일 시스템을 검사하기 때문에 시간이 매우 오래 걸림

저널링 기법이란?

- 작업 로그를 통해 시스템 크래시가 발생했을 때 빠르게 복구하기 위한 방법
1. 작업 직전 파티션의 로그 영역에 수행하는 작업에 대한 로그를 남긴다.
2. 로그를 남긴 후 작업을 수행한다.
3. 작업이 끝났다면 로그를 삭제한다.

⇒ 시스템 크래시가 발생해도 로그 영역에 남긴 로그만 검사해도 된다.

---

### 마운트

한 저장 장치의 파일 시스템에서 다른 저장 장치의 파일 시스템에 접근할 수 있도록 파일 시스템을 편입시키는 작업을 의미 (USB 등)

새로운 저장 장치를 꽂는다고 자동으로 트리에 편입되지 않으므로 마운트 과정을 거쳐야 한다.

1. 운영체제가 지정된 디렉터리를 마운트 지점으로 사용
2. 장치 안의 파일 시스템을 확인하고, 디렉터리 트리에 연결
3. 연결 후에는 사용자가 해당 디렉터리를 통해 저장 장치 안의 파일에 접근 가능